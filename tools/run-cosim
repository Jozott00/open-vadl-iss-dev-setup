#!/bin/bash
# Run the CoSim testsuite using a test-suite*.yaml specification.

set -euo pipefail

test_scripts_path="$OPEN_VADL_DIR/vadl-test/resources/cosim_scripts/ppc64"
test_runner="$test_scripts_path/main.py"

if [[ ! -f "$test_runner" ]]; then
  echo "Error: test runner not found: $test_runner" >&2
  exit 1
fi

if [[ -z "${TESTSUITE_DIR:-}" ]]; then
  echo "Error: TESTSUITE_DIR is not set" >&2
  exit 1
fi

cd "$TESTSUITE_DIR"

suite_name="${1:-}"
suite_file=""

if [[ -n "$suite_name" ]]; then
  if [[ "$suite_name" == *.yaml ]]; then
    suite_file="$suite_name"
  elif [[ "$suite_name" == test-suite-* ]]; then
    suite_file="${suite_name}.yaml"
  else
    suite_file="test-suite-${suite_name}.yaml"
  fi
else
  suite_file="test-suite-ppc64.yaml"
fi

if [[ ! -f "$suite_file" ]]; then
  echo "Error: suite file not found: $suite_file" >&2
  echo "Usage: run-cosim [suite-name|suite.yaml]" >&2
  exit 1
fi

echo "Running cosim testsuite: $suite_file"
python3 "$test_runner" "$suite_file"
